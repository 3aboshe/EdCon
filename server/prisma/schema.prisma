// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_PUBLIC_URL")
}

model School {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  address   String?
  timezone  String?  @default("UTC")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  classes       Class[]
  subjects      Subject[]
  grades        Grade[]
  exams         Exam[]
  homework      Homework[]
  announcements Announcement[]
  attendance    Attendance[]
  messages      Message[]
  automationSuggestions AutomationSuggestion[]
  workflowExecutions   WorkflowExecution[]
  learnedPatterns      LearnedPattern[]
  bulkOperations       BulkOperation[]

  @@map("schools")
}

model User {
  id                     String   @id @default(cuid())
  accessCode             String   @unique
  schoolId               String?
  schoolCode             String?
  role                   UserRole
  status                 UserStatus @default(ACTIVE)
  name                   String
  email                  String?
  phone                  String?
  avatar                 String   @default("")
  passwordHash           String
  temporaryPasswordHash  String?
  temporaryPasswordIssuedAt DateTime?
  requiresPasswordReset  Boolean  @default(false)
  lastLoginAt            DateTime?
  classId                String?
  parentId               String?
  subject                String?
  classIds               String[] @default([])
  childrenIds            String[] @default([])
  messagingAvailability  Json?
  metadata               Json?
  createdById            String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  school        School?  @relation(fields: [schoolId], references: [id])
  class         Class?   @relation("StudentClass", fields: [classId], references: [id])
  parent        User?    @relation("ParentChild", fields: [parentId], references: [id])
  children      User[]   @relation("ParentChild")
  createdBy     User?    @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers  User[]   @relation("UserCreator")
  homework      Homework[] @relation("HomeworkTeacher")
  announcements Announcement[] @relation("AnnouncementTeacher")
  exams         Exam[]   @relation("ExamTeacher")
  grades        Grade[]  @relation("StudentGrades")
  attendance    Attendance[] @relation("StudentAttendance")
  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  submittedHomework Homework[] @relation("HomeworkSubmissions")
  encryptionKeys   EncryptionKey[]

  @@map("users")
}

model Class {
  id         String   @id @default(cuid())
  name       String
  schoolId   String
  subjectIds String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  school  School @relation(fields: [schoolId], references: [id])
  students User[] @relation("StudentClass")
  exams    Exam[]

  @@map("classes")
}

model Subject {
  id        String   @id @default(cuid())
  name      String
  schoolId  String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id])

  @@map("subjects")
}

model Grade {
  id             String    @id @default(cuid())
  studentId      String
  schoolId       String
  subject        String
  assignment     String
  marksObtained  Int
  maxMarks       Int
  date           DateTime  @default(now())
  type           GradeType @default(QUIZ)
  examId         String?

  school  School @relation(fields: [schoolId], references: [id])
  student User   @relation("StudentGrades", fields: [studentId], references: [id])
  exam    Exam?  @relation(fields: [examId], references: [id])

  @@map("grades")
}

model Exam {
  id        String   @id @default(cuid())
  title     String
  date      DateTime
  maxScore  Int
  teacherId String
  classId   String
  subject   String
  schoolId  String
  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id])
  teacher User   @relation("ExamTeacher", fields: [teacherId], references: [id])
  class   Class  @relation(fields: [classId], references: [id])
  grades  Grade[]

  @@map("exams")
}

model Homework {
  id           String   @id @default(cuid())
  title        String
  description  String?
  subject      String
  dueDate      DateTime
  assignedDate DateTime
  teacherId    String
  schoolId     String
  classIds     String[] @default([])
  submitted    String[] @default([])
  attachments  Json?    @default("[]")
  createdAt    DateTime @default(now())

  school      School @relation(fields: [schoolId], references: [id])
  teacher     User   @relation("HomeworkTeacher", fields: [teacherId], references: [id])
  submittedBy User[] @relation("HomeworkSubmissions")

  @@map("homework")
}

model Announcement {
  id        String               @id @default(cuid())
  title     String
  content   String
  date      DateTime
  teacherId String
  schoolId  String
  classIds  String[]             @default([])
  priority  AnnouncementPriority @default(MEDIUM)
  createdAt DateTime             @default(now())

  school  School @relation(fields: [schoolId], references: [id])
  teacher User   @relation("AnnouncementTeacher", fields: [teacherId], references: [id])

  @@map("announcements")
}

model Attendance {
  id        String           @id @default(cuid())
  date      DateTime
  studentId String
  schoolId  String
  status    AttendanceStatus
  createdAt DateTime         @default(now())

  school  School @relation(fields: [schoolId], references: [id])
  student User   @relation("StudentAttendance", fields: [studentId], references: [id])

  @@map("attendance")
}

model Message {
  id                String      @id @default(cuid())
  senderId          String
  receiverId        String
  schoolId          String
  timestamp         DateTime    @default(now())
  isRead            Boolean     @default(false)
  type              MessageType @default(TEXT)
  content           String?
  audioSrc          String?
  attachments       Json?
  createdAt         DateTime    @default(now())

  // Encryption fields for end-to-end encryption
  encryptedContent  String?
  encryptedAesKey   String?
  iv                String?
  encryptionVersion Int         @default(1)
  isEncrypted       Boolean     @default(false)

  school   School @relation(fields: [schoolId], references: [id])
  sender   User   @relation("MessageSender", fields: [senderId], references: [id])
  receiver User   @relation("MessageReceiver", fields: [receiverId], references: [id])

  @@map("messages")
}

// Encryption key management for end-to-end encryption
model EncryptionKey {
  id         String   @id @default(cuid())
  userId     String
  publicKey  String
  keyVersion Int      @default(1)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, keyVersion])
  @@map("encryption_keys")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  PARENT
  STUDENT
}

enum UserStatus {
  ACTIVE
  INVITED
  SUSPENDED
  DISABLED
}

enum GradeType {
  QUIZ
  TEST
  HOMEWORK
  PROJECT
  EXAM
}

enum AnnouncementPriority {
  HIGH
  MEDIUM
  LOW
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum MessageType {
  TEXT
  VOICE
  FILE
}

// Automation tables scoped to schools for governance features
model AutomationSuggestion {
  id             Int      @id @default(autoincrement())
  schoolId       String?
  entityType     String
  entityId       String?
  suggestionType String
  suggestionData Json
  confidenceScore Float   @default(0.0)
  accepted       Boolean  @default(false)
  createdAt      DateTime @default(now())
  appliedAt      DateTime?

  school School? @relation(fields: [schoolId], references: [id])

  @@map("automation_suggestions")
}

model WorkflowExecution {
  id              Int      @id @default(autoincrement())
  schoolId        String?
  workflowType    String
  triggerData     Json
  executionStatus String   @default("pending")
  stepsCompleted  Json     @default("[]")
  resultData      Json?
  errorMessage    String?
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  school School? @relation(fields: [schoolId], references: [id])

  @@map("workflow_executions")
}

model LearnedPattern {
  id             Int      @id @default(autoincrement())
  schoolId       String?
  patternType    String
  patternData    Json
  successCount   Int      @default(0)
  failureCount   Int      @default(0)
  confidenceScore Float   @default(0.0)
  lastApplied    DateTime?
  createdAt      DateTime @default(now())

  school School? @relation(fields: [schoolId], references: [id])

  @@map("learned_patterns")
}

model BulkOperation {
  id                Int      @id @default(autoincrement())
  schoolId          String?
  operationType     String
  entityType        String
  totalRecords      Int      @default(0)
  successfulRecords Int      @default(0)
  failedRecords     Int      @default(0)
  operationData     Json?
  status            String   @default("pending")
  createdBy         String?
  createdAt         DateTime @default(now())
  completedAt       DateTime?

  school School? @relation(fields: [schoolId], references: [id])

  @@map("bulk_operations")
}
